#!/usr/bin/env bash
set -euo pipefail

# -----------------------
# SETTINGS
# -----------------------
MERGED_PREFIX="ukb22418_c1_22_v2_merged_HA_DS"
PROJECT_DATA_DIR="/Data"          # this is the *project folder path* for dx download
OUT_PREFIX="HA_DS_step1_qc_pass"
INSTANCE_TYPE="mem1_ssd1_v2_x16"

# QC thresholds
MAF="0.01"
MAC="20"
GENO="0.1"
MIND="0.1"
HWE="1e-15"

run_qc=$(cat <<'EOF'
set -euo pipefail

MERGED_PREFIX="ukb22418_c1_22_v2_merged_HA_DS"
PROJECT_DATA_DIR="/Data"
OUT_PREFIX="HA_DS_step1_qc_pass"

echo "Working dir: $(pwd)"
dx whoami || true
dx pwd || true

echo "Downloading merged bed/bim/fam from project folder..."
dx download "${PROJECT_DATA_DIR}/${MERGED_PREFIX}.bed" -o "${MERGED_PREFIX}.bed"
dx download "${PROJECT_DATA_DIR}/${MERGED_PREFIX}.bim" -o "${MERGED_PREFIX}.bim"
dx download "${PROJECT_DATA_DIR}/${MERGED_PREFIX}.fam" -o "${MERGED_PREFIX}.fam"

echo "Local files:"
ls -lh ${MERGED_PREFIX}.{bed,bim,fam}

echo "Running PLINK2 QC filter (write snplist + samples)..."
plink2 \
  --bfile ${MERGED_PREFIX} \
  --autosome \
  --maf 0.01 \
  --mac 20 \
  --geno 0.1 \
  --mind 0.1 \
  --hwe 1e-15 \
  --write-snplist \
  --write-samples \
  --no-id-header \
  --out ${OUT_PREFIX}

echo "Outputs:"
ls -lh ${OUT_PREFIX}.*
echo "SNPs kept:"
wc -l ${OUT_PREFIX}.snplist || true
echo "Samples kept:"
wc -l ${OUT_PREFIX}.id || true
EOF
)

dx run swiss-army-knife \
  -icmd="${run_qc}" \
  --tag="PartC_step1_qc_filter" \
  --instance-type "${INSTANCE_TYPE}" \
  --destination="/Data/qc_1to10/" \
  --brief --yes

