#!/usr/bin/env bash
set -euo pipefail

# -----------------------
# USER SETTINGS
# -----------------------
PHENO_FILE_ID="file-J5qxX2jJB65jpb7K5ZJXkbVz"   # your phenotype file ID
OUT_PREFIX="ukb22418_c1_22_v2_merged_HA_DS"

BULK_GENO_DIR="/mnt/project/Bulk/Genotype Results/Genotype calls"
INSTANCE_TYPE="mem1_ssd1_v2_x16"

# swiss-army-knife still requires at least one -iin input
# we can use the same phenotype file id as the dummy input
INPUT_FILE_ID="${PHENO_FILE_ID}"

# -----------------------
# COMMAND THAT RUNS IN THE JOB CONTAINER
# -----------------------
run_merge=$(cat <<'EOF'
set -euo pipefail

echo "Working dir: $(pwd)"
echo "DX whoami (sanity):"
dx whoami || true

# 1) Fetch phenotype directly by file-id (most robust)
echo "Downloading phenotype via dx cat..."
dx cat "${PHENO_FILE_ID}" > pheno.tsv

echo "Phenotype header:"
head -n 1 pheno.tsv

# 2) Build keep file (FID IID) from phenotype
awk -F'\t' 'NR==1{
  for(i=1;i<=NF;i++){h[$i]=i}
  if(!("FID" in h) || !("IID" in h)){
    print "ERROR: pheno must contain FID and IID columns" > "/dev/stderr"
    exit 1
  }
  next
}
{ print $h["FID"], $h["IID"] }' pheno.tsv > keep.ids

echo "Keep IDs count:"
wc -l keep.ids
echo "Keep IDs (first 5):"
head -n 5 keep.ids

# 3) Copy chr1-22 bed/bim/fam into working directory
for c in $(seq 1 22); do
  base="ukb22418_c${c}_b0_v2"
  for ext in bed bim fam; do
    src="${BULK_GENO_DIR}/${base}.${ext}"
    if [ ! -f "$src" ]; then
      echo "ERROR: missing $src" >&2
      exit 1
    fi
    cp "$src" .
  done
done

# 4) Build merge list
ls ukb22418_c*_b0_v2.bed | sed 's/\.bed$//' | sort -V > all_prefixes.txt
head_prefix=$(head -n 1 all_prefixes.txt)
tail -n +2 all_prefixes.txt > merge_list.txt

echo "Head (base dataset): $head_prefix"
echo "Merge list lines:"
wc -l merge_list.txt

# 5) Merge + keep only your IDs
plink \
  --bfile "$head_prefix" \
  --merge-list merge_list.txt \
  --keep keep.ids \
  --make-bed \
  --autosome-xy \
  --out ukb22418_c1_22_v2_merged_HA_DS

echo "Outputs:"
ls -lh ukb22418_c1_22_v2_merged_HA_DS.*
EOF
)

# Export variables into job env (EOF is single-quoted)
run_merge="export BULK_GENO_DIR=\"${BULK_GENO_DIR}\"; export PHENO_FILE_ID=\"${PHENO_FILE_ID}\"; ${run_merge}"

# -----------------------
# LAUNCH
# -----------------------
dx run swiss-army-knife \
  -iin="${INPUT_FILE_ID}" \
  -icmd="${run_merge}" \
  --tag="HA_merge_array_keep_DS" \
  --instance-type "${INSTANCE_TYPE}" \
  --destination="/Data/" \
  --brief --yes



#Verify
dx ls -l /Data/ukb22418_c1_22_v2_merged_HA_DS.fam
dx cat /Data/ukb22418_c1_22_v2_merged_HA_DS.fam | wc -l
